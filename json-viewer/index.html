<!DOCTYPE html>
<html>

<head>
    <title>JSON Editor</title>
    <style>
        body {
            display: grid;
            grid-template-columns: 60% 40%;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(to right, #00863B 60%, #00863B 60%, #BCCF00 100%);
            font-family: "Poppins", Arial, sans-serif;
        }

        .main-header,
        .intro-text {
            color: #494848;
        }

        span {
            margin-top: 20px;
        }

        #output {
            margin-top: 20px;
            padding: 30px;
            background: #fff;
            border: 1px solid #ccc;
            font-size: 16px;
            white-space: pre-wrap;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 5px;
        }

        .json-key {
            font-weight: bold;
            color: #155724;
        }

        input[type="text"],
        select {
            margin-top: 15px;
            margin-bottom: 15px;
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            height: 50px;
        }

        select option {
            padding: 20px 20px;
            margin: 20px;
            font-size: 20px;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            margin-right: 5px;
        }

        button:hover {
            background-color: #0056b3;
        }

        div.object-item,
        div.array-item {
            margin-left: 20px;
            border-left: 3px solid #007bff;
            padding-left: 10px;
            margin-bottom: 10px;
        }

        div.object-item {
            background-color: #eef;
        }

        div.array-item {
            background-color: #ffe;
        }

        #preview {
            height: 100vh;
            overflow-y: auto;
            position: sticky;
            top: 20px;
            padding: 50px;
        }

        #preview h2 {
            color: #fff;
        }

        #previewContent {
            background-color: #fff;
            padding: 50px;
            border-radius: 10px;
        }

        .textarea-container {
            height: 100vh;
            overflow-y: auto;
            background-color: #f3f3f3;
            padding: 50px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        #jsonInput {
            width: 100%;
            border-radius: 10px;
            border: 1px solid #b6b5b5;
            margin-bottom: 15px;
        }

        /* Flex layout for key-value pairs */
        .kv-pair {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        /* Ensure that the key and input are properly spaced */
        .kv-pair span {
            margin-right: 10px;
            font-weight: bold;
        }

        /* Make input take available space */
        .kv-pair input {
            margin-right: 10px;
            flex: 1;
        }

        /* Style for the delete button */
        .kv-pair .delete-button {
            background-color: red;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
        }

        /* Hover effect for the delete button */
        .kv-pair .delete-button:hover {
            background-color: darkred;
        }

        /* Container for items, vertically stacked */
        .item-container {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
        }

        /* Buttons container, inline flex */
        .item-buttons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        /* Individual buttons within the button container */
        .item-buttons button {
            margin: 5px;
            flex: 0 1 auto;
        }
    </style>
</head>

<body>
    <div class="textarea-container">
        <h1 class="main-header">JSON Editor</h1>
        <p class="intro-text">Insert JSON and press Load JSON to populate the tool. Making edits to via the interface
            will update both the JSON and Live Preview. </p>
        <textarea id="jsonInput" rows="10" cols="50"></textarea><br>
        <button onclick="displayJson()">Load JSON</button><br>
        <select id="productSelect" onchange="populateItemDropdown()"></select>
        <button onclick="addObjectToSelectedProduct()">Add Object to Selected Product</button><br>
        <select id="itemSelect"></select>
        <button onclick="removeSelectedItem()">Remove Selected Item</button>
        <div id="output"></div>
    </div>

    <div id="preview">
        <h2>Live Preview</h2>
        <div id="previewContent"></div>
    </div>

    <script>
        let jsonData = {};

        function encodeAmpersands(jsonString) {
            return jsonString.replace(/&(?!amp;)/g, '&amp;');
        }

        function decodeAmpersands(text) {
            return typeof text === 'string' ? text.replace(/&amp;/g, '&') : text;
        }

        function readAndEncodeJson(inputId) {
            const jsonInput = document.getElementById(inputId).value;
            return encodeAmpersands(jsonInput);
        }

        function parseJson(jsonString) {
            try {
                return JSON.parse(jsonString);
            } catch (e) {
                console.error("Invalid JSON:", e);
                return null;
            }
        }

        function updateTextarea(textareaId, text) {
            document.getElementById(textareaId).value = text;
        }

        function clearElementHtml(element) {
            element.innerHTML = '';
        }

        function updateUi(jsonData, outputId) {
            const outputDiv = document.getElementById(outputId);
            clearElementHtml(outputDiv);
            createEditableFields(jsonData, outputDiv);
            if (jsonData && jsonData.data && jsonData.data.products) {
                populateProductDropdown();
                populateItemDropdown();
                updatePreview();
            }
        }

        function displayJson() {
            const encodedJson = readAndEncodeJson('jsonInput');
            jsonData = parseJson(encodedJson);

            if (jsonData) {
                updateTextarea('jsonInput', encodedJson);
                updateUi(jsonData, 'output');
            } else {
                document.getElementById('output').innerText = 'Invalid JSON!';
            }
            console.log(jsonData);
        }

        function setValueAt(path, value) {
            const encodedValue = encodeAmpersands(value);

            let obj = jsonData;
            for (let i = 0; i < path.length - 1; i++) {
                obj = obj[path[i]];
                if (obj === undefined) {
                    return;
                }
            }
            obj[path[path.length - 1]] = encodedValue;

            updateJsonDisplay();
            updatePreview();
        }

        function addBlurListenerAndUpdateField(input, path, key) {
            input.addEventListener('blur', function () {
                const newValue = input.value;
                const encodedValue = encodeAmpersands(newValue);

                if (newValue !== encodedValue) {
                    input.value = encodedValue;
                }

                setValueAt(path.concat(key), encodedValue);
                displayJson();
            });
        }

        function createEditableFields(data, parentElement, path = []) {
            if (Array.isArray(data)) {
                data.forEach((item, index) => {
                    const title = item.title ? item.title : `Item ${index + 1}`;

                    const div = document.createElement('div');
                    div.className = 'item-container';

                    const buttonDiv = document.createElement('div');
                    buttonDiv.className = 'item-buttons';

                    if (index > 0) {
                        const upButton = document.createElement('button');
                        upButton.textContent = `Move Up: ${title}`;
                        upButton.onclick = function () {
                            moveItem(path, index, -1);
                        };
                        buttonDiv.appendChild(upButton);
                    }

                    if (index < data.length - 1) {
                        const downButton = document.createElement('button');
                        downButton.textContent = `Move Down: ${title}`;
                        downButton.onclick = function () {
                            moveItem(path, index, 1);
                        };
                        buttonDiv.appendChild(downButton);
                    }

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = `Delete ${title}`;
                    deleteButton.onclick = function () {
                        deleteItem(path, index);
                    };
                    buttonDiv.appendChild(deleteButton);

                    const duplicateButton = document.createElement('button');
                    duplicateButton.textContent = `Duplicate ${title}`;
                    duplicateButton.onclick = function () {
                        duplicateItem(path, index);
                    };
                    buttonDiv.appendChild(duplicateButton);

                    const addKeyValueButton = document.createElement('button');
                    addKeyValueButton.textContent = `Add Key-Value to ${title}`;
                    addKeyValueButton.onclick = function () {
                        addKeyValuePairToObject(path, index);
                    };
                    buttonDiv.appendChild(addKeyValueButton);

                    div.appendChild(buttonDiv);

                    const label = document.createElement('span');
                    label.className = "json-key";
                    label.innerHTML = `<h2>Item ${index + 1}: ${title}</h2>`;
                    label.style.display = 'block';
                    label.style.textAlign = 'center';
                    div.appendChild(label);

                    const innerDiv = document.createElement('div');
                    innerDiv.style.margin = '10px 20px';
                    createEditableFields(item, innerDiv, path.concat(index));
                    div.appendChild(innerDiv);

                    parentElement.appendChild(div);
                });
            } else if (typeof data === 'object' && data !== null) {
                Object.keys(data).forEach((key) => {
                    if (['data', 'products', 'items'].includes(key)) {
                        createEditableFields(data[key], parentElement, path.concat(key));
                    } else {
                        const div = document.createElement('div');
                        div.className = 'kv-pair';

                        const span = document.createElement('span');
                        span.textContent = key + ': ';
                        div.appendChild(span);

                        if (typeof data[key] === 'object' && data[key] !== null) {
                            const nestedDiv = document.createElement('div');
                            nestedDiv.style.marginLeft = '20px';
                            createEditableFields(data[key], nestedDiv, path.concat(key));
                            div.appendChild(nestedDiv);
                        } else {
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.value = encodeAmpersands(data[key].toString());

                            addBlurListenerAndUpdateField(input, path, key);

                            div.appendChild(input);

                            const deleteButton = document.createElement('button');
                            deleteButton.textContent = 'Delete';
                            deleteButton.className = 'delete-button';
                            deleteButton.onclick = function () {
                                removeKeyValue(path, key);
                            };
                            div.appendChild(deleteButton);
                        }
                        parentElement.appendChild(div);
                    }
                });
            } else {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = encodeAmpersands(data.toString());

                addBlurListenerAndUpdateField(input, path);

                parentElement.appendChild(input);
            }
        }

        function addKeyValuePairToObject(path, index) {
            console.log("addKeyValuePairToObject called with path:", path, "and index:", index);

            // Get the specific object where the new key-value pair will be added
            let obj = getValueAt(path.concat(index));
            console.log("Target object to add key-value:", obj);

            if (obj && typeof obj === 'object') {
                let key = prompt("Enter new key:");
                if (!key) {
                    alert("Key cannot be empty.");
                    return;
                }
                let value = prompt("Enter value for " + key + ":");
                if (value === null) {
                    alert("Process cancelled.");
                    return;
                }
                obj[key] = encodeAmpersands(value); // Encode ampersands in the new value

                updateJsonDisplay(); // Update the JSON textarea
                displayJson(); // Refresh the UI
            } else {
                console.error("Target object is not valid for adding key-value pair");
            }
        }


        function removeKeyValue(path, key) {
            console.log("removeKeyValue called with path:", path, "and key:", key);

            const parentPath = path;
            const obj = getValueAt(parentPath);
            console.log("Object at path:", parentPath, obj);

            if (obj && obj.hasOwnProperty(key)) {
                console.log(`Deleting key "${key}" from`, obj);
                delete obj[key];
                updateJsonDisplay();
                displayJson();
            } else {
                console.error("Key not found or object is undefined");
            }
        }

        function duplicateItem(path, index) {
            const arr = getValueAt(path);
            if (arr && index >= 0 && index < arr.length) {
                const newItem = JSON.parse(JSON.stringify(arr[index]));
                arr.splice(index + 1, 0, newItem);

                updateJsonDisplay();
                displayJson();
            }
        }

        function deleteItem(path, index) {
            const arr = getValueAt(path);
            if (arr && index >= 0 && index < arr.length) {
                arr.splice(index, 1);

                updateJsonDisplay();
                displayJson();
            }
        }

        function moveItem(path, index, direction) {
            const arr = getValueAt(path);
            if (!arr || index + direction < 0 || index + direction >= arr.length) {
                return;
            }

            const item = arr.splice(index, 1)[0];
            arr.splice(index + direction, 0, item);

            updateJsonDisplay();
            displayJson();
        }

        function getValueAt(path) {
            let obj = jsonData;
            for (let i = 0; i < path.length; i++) {
                obj = obj[path[i]];
                if (obj === undefined) {
                    console.error("Path is invalid at", path[i]);
                    return undefined;
                }
            }
            return obj;
        }

        function updateJsonDisplay() {
            document.getElementById('jsonInput').value = JSON.stringify(jsonData, null, 2);
        }

        function addObjectToSelectedProduct() {
            const productIndex = document.getElementById('productSelect').value;
            const productTitle = jsonData.data.products[productIndex].title;
            addNewObjectToCategory(productTitle);
        }

        function addNewObjectToCategory(categoryTitle) {
            const numberOfPairs = parseInt(prompt("How many key/value pairs would you like to add?"));
            if (isNaN(numberOfPairs) || numberOfPairs <= 0) {
                alert("Please enter a valid number greater than 0.");
                return;
            }

            const newItem = {};

            for (let i = 0; i < numberOfPairs; i++) {
                const key = prompt("Enter key " + (i + 1) + ":");
                if (!key) {
                    alert("Key cannot be empty. Restarting process.");
                    return;
                }
                const value = prompt("Enter value for " + key + ":");
                if (value === null) {
                    alert("Process cancelled.");
                    return;
                }
                newItem[key] = value;
            }

            const category = jsonData.data.products.find(function (product) {
                return product.title === categoryTitle;
            });

            if (category) {
                if (!category.items) {
                    category.items = [];
                }
                category.items.push(newItem);

                updateJsonDisplay();
                displayJson();
            }
        }

        function populateProductDropdown() {
            const select = document.getElementById('productSelect');
            select.innerHTML = '';
            if (jsonData.data && jsonData.data.products) {
                jsonData.data.products.forEach(function (product, index) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = product.title;
                    select.appendChild(option);
                });
            }
        }

        function populateItemDropdown() {
            const productIndex = document.getElementById('productSelect').value;
            const select = document.getElementById('itemSelect');
            select.innerHTML = '';

            if (!jsonData.data.products[productIndex].items) {
                jsonData.data.products[productIndex].items = [];
            }

            const items = jsonData.data.products[productIndex].items;
            items.forEach(function (item, index) {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = item.title || "Item " + index;
                select.appendChild(option);
            });
        }

        function removeSelectedItem() {
            const productIndex = document.getElementById('productSelect').value;
            const itemIndex = document.getElementById('itemSelect').value;

            if (!jsonData.data.products[productIndex].items) {
                alert("No items to remove.");
                return;
            }

            jsonData.data.products[productIndex].items.splice(itemIndex, 1);

            updateJsonDisplay();
            displayJson();
        }

        function updatePreview() {
            const preview = document.getElementById('previewContent');
            preview.innerHTML = '';

            if (jsonData && jsonData.data && jsonData.data.products) {
                jsonData.data.products.forEach(function (product) {
                    const productDiv = document.createElement('div');
                    productDiv.textContent = decodeAmpersands(product.title);
                    productDiv.style.padding = '5px 0';
                    productDiv.style.fontWeight = 'bold';

                    if (product.items && product.items.length > 0) {
                        const itemList = document.createElement('ul');
                        product.items.forEach(function (item) {
                            const itemLi = document.createElement('li');
                            itemLi.textContent = decodeAmpersands(item.title);
                            itemList.appendChild(itemLi);
                        });
                        productDiv.appendChild(itemList);
                    }

                    preview.appendChild(productDiv);
                });
            } else {
                preview.textContent = 'No products to display';
            }
        }

        populateProductDropdown();

    </script>
</body>

</html>