<!DOCTYPE html>
<html>

<head>
    <title>JSON Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #output {
            margin-top: 20px;
            white-space: pre-wrap;
            font-size: 16px;
        }

        .json-key {
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        input[type="text"] {
            margin-top: 5px;
            width: 400px;
        }
    </style>
</head>

<body>
    <h1>JSON Editor</h1>
    <textarea id="jsonInput" rows="10" cols="50"></textarea><br>
    <button onclick="displayJson()">Load JSON</button>
    <div id="output"></div>
    <!-- Dropdown for selecting product -->
    <select id="productSelect" onchange="populateItemDropdown()"></select>

    <!-- Dropdown for selecting item to remove -->
    <select id="itemSelect"></select>

    <!-- Button to remove the selected item -->
    <button onclick="removeSelectedItem()">Remove Selected Item</button>

    <script>
        // Declare jsonData as a global variable to hold the parsed JSON
        var jsonData = {};

        function displayJson() {
            var jsonInput = document.getElementById('jsonInput').value;
            try {
                jsonData = JSON.parse(jsonInput); // Parse JSON input and store in the global variable
                var outputDiv = document.getElementById('output');
                outputDiv.innerHTML = ''; // Clear previous output
                createEditableFields(jsonData, outputDiv); // Generate new editable fields

                // Populate dropdowns if products exist
                if (jsonData && jsonData.data && jsonData.data.products) {
                    populateProductDropdown(); // This should only be called here to ensure data is loaded
                    populateItemDropdown(); // Populate items for the first product by default

                    // After creating fields for products, add a button for adding new objects
                    jsonData.data.products.forEach(function (product, index) {
                        // Create a new button to add objects to the category
                        var addButton = document.createElement('button');
                        addButton.textContent = "Add New Object to " + product.title;
                        addButton.onclick = function () {
                            addNewObjectToCategory(product.title);
                        };
                        outputDiv.appendChild(addButton); // Append the button directly to outputDiv for simplicity
                    });
                }
            } catch (e) {
                document.getElementById('output').innerText = 'Invalid JSON!';
            }
        }

        function createEditableFields(data, parentElement, path = []) {
            if (Array.isArray(data)) {
                data.forEach((item, index) => {
                    var div = document.createElement('div');
                    div.innerHTML = `<span class="json-key">Item ${index + 1}:</span>`;
                    var innerDiv = document.createElement('div');
                    innerDiv.style.marginLeft = '20px';
                    createEditableFields(item, innerDiv, path.concat(index));
                    div.appendChild(innerDiv);
                    parentElement.appendChild(div);
                });
            } else if (typeof data === 'object' && data !== null) {
                Object.keys(data).forEach((key) => {
                    var div = document.createElement('div');
                    var span = document.createElement('span');
                    span.textContent = key + ': ';
                    div.appendChild(span);

                    if (typeof data[key] === 'object' && data[key] !== null) {
                        createEditableFields(data[key], div, path.concat(key));
                    } else {
                        var input = document.createElement('input');
                        input.type = 'text';
                        input.value = data[key];
                        input.onchange = function () {
                            // Find the object to update using the path, and update the key with the new value
                            let objToUpdate = jsonData;
                            path.forEach((p) => { objToUpdate = objToUpdate[p]; });
                            objToUpdate[key] = input.value;

                            // Update the textarea with the stringified JSON
                            updateJsonDisplay();
                        };
                        div.appendChild(input);
                    }
                    parentElement.appendChild(div);
                });
            } else {
                var input = document.createElement('input');
                input.type = 'text';
                input.value = data;
                input.onchange = function () {
                    let objToUpdate = jsonData;
                    path.slice(0, -1).forEach((p) => { objToUpdate = objToUpdate[p]; });
                    objToUpdate[path[path.length - 1]] = input.value;

                    updateJsonDisplay();
                };
                parentElement.appendChild(input);
            }
        }

        function updateJsonDisplay() {
            document.getElementById('jsonInput').value = JSON.stringify(jsonData, null, 2);
        }

        function addNewObjectToCategory(categoryTitle) {
            // Prompt user for the number of key/value pairs they want to add
            var numberOfPairs = parseInt(prompt("How many key/value pairs would you like to add?"));
            if (isNaN(numberOfPairs) || numberOfPairs <= 0) {
                alert("Please enter a valid number greater than 0.");
                return; // Exit if the number is not valid
            }

            // Create new item object
            var newItem = {};

            // Loop through the number of pairs and prompt for each key and value
            for (var i = 0; i < numberOfPairs; i++) {
                var key = prompt("Enter key " + (i + 1) + ":");
                if (!key) {
                    alert("Key cannot be empty. Restarting process.");
                    return; // Exit if no key is provided
                }
                var value = prompt("Enter value for " + key + ":");
                if (value === null) {
                    alert("Process cancelled.");
                    return; // Exit if user cancels the value prompt
                }
                newItem[key] = value;
            }

            // Find the category in jsonData
            var category = jsonData.data.products.find(function (product) {
                return product.title === categoryTitle;
            });

            if (category) {
                // Assuming 'items' is an array where new objects should be added
                if (!category.items) {
                    category.items = []; // Initialize 'items' if it doesn't exist
                }
                // Add the new item to the category's items array
                category.items.push(newItem);

                // Update the JSON display
                updateJsonDisplay();

                // Re-display all the fields to include the new item
                displayJson();
            }
        }
        function populateProductDropdown() {
            var select = document.getElementById('productSelect');
            select.innerHTML = ''; // Clear existing options
            jsonData.data.products.forEach(function (product, index) {
                var option = document.createElement('option');
                option.value = index;
                option.textContent = product.title;
                select.appendChild(option);
            });
        }

        // Updated to check if 'items' exists when populating item dropdown
        function populateItemDropdown() {
            var productIndex = document.getElementById('productSelect').value;
            var select = document.getElementById('itemSelect');
            select.innerHTML = ''; // Clear existing options

            if (!jsonData.data.products[productIndex].items) {
                jsonData.data.products[productIndex].items = []; // Initialize if not exist
            }

            var items = jsonData.data.products[productIndex].items;
            items.forEach(function (item, index) {
                var option = document.createElement('option');
                option.value = index;
                option.textContent = item.title || "Item " + index;
                select.appendChild(option);
            });
        }

        // Ensuring that removeSelectedItem checks if items exist
        function removeSelectedItem() {
            var productIndex = document.getElementById('productSelect').value;
            var itemIndex = document.getElementById('itemSelect').value;

            if (!jsonData.data.products[productIndex].items) {
                alert("No items to remove.");
                return; // Guard against undefined items array
            }

            // Remove the item from the array
            jsonData.data.products[productIndex].items.splice(itemIndex, 1);

            // Update display
            updateJsonDisplay();
            displayJson();
        }
        // Call this function on initial load and after updates
        populateProductDropdown();
    </script>

</body>

</html>